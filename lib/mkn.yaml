#! clean build -dtS

name: tick

self: tick.py

property:
    lib_path: ./../tick
    cargs: -DNPY_NO_DEPRECATED_API=NPY_1_7_API_VERSION -D_FILE_OFFSET_BITS=64 -DPYTHON_LINK
    win_cargs: -GL -MD -EHsc -std:c++17
    nixish_cargs: -fwrapv -fstack-protector-strong
                  -Wformat -Wdate-time
                  -D_FORTIFY_SOURCE=2 -fPIC -std=c++17
                  -Wno-uninitialized
    nixish_largs: -fstack-protector-strong -Wformat
                  -Werror=format-security -Wdate-time
                  -D_FORTIFY_SOURCE=2
    nix_largs: ${nixish_largs} -pthread
               -Wl,-O1 -Wl,-Bsymbolic-functions
               -Wl,-z,relro -Wl,-z,relro
    bsd_largs: ${nixish_largs}


profile:
  - name: arg
    arg: ${cargs}
    inc:
      ./include
      ./third_party/cereal/include
    if_arg:
      win: ${win_cargs}
      nix: ${nixish_cargs}
      bsd: ${nixish_cargs}
    if_link:
      nix_lib: ${nix_largs}
      bsd_lib: ${bsd_largs}
      win: -LTCG
    mod: |
      lang.python3{compile{with: numpy}, link{delete: CoreFoundation }}

  - name: tick.py
    parent: arg
    src: cpp swig/tick
    install: ${lib_path}/tick_cpp
    out: _tick_cpp
    arg: -DBUILDING_DLL
    mod:
    - name: lang.swig
      compile:
        inc: include swig
        src: swig/tick/module.i
        outdir: ../tick/tick_cpp
        objfile: tick_module_wrap.cpp

  - name: gtest_lib
    parent: arg
    arg: -DBUILDING_DLL
    src: cpp

  - name: gtest
    parent: arg
    self: gtest_lib
    dep: google.test
    arg: -DGTEST_LINKED_AS_SHARED_LIBRARY -DADD_MAIN
    # run: find lib/cpp-test -name "*gtest.cpp"
